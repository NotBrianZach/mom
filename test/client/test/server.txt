listen:
  listen
  sock = accept
  checkBlackList sock
  (forkIO sock) doRcv

doRcv
  b <- rcv max
  m <- parse b
  handle m
  killThread (?)

handle m
  writeChan m

handler
  m <- readChan 
  case m of
    send -> send m
    con  -> con  m
    ...

send m
  writeChan m

sender 
  m <- readChan
  let m' = if null $ rec m
             then
               m' = m{rec = getReceivers}
             else
               m
  r <- mapM sendRec m'
  x <- isEmptyChan 
  if null r 
    then if x 
           then threadDelay >>= sender
           else sender 
    else
      writeChan m'
      if x then threadDelay >>= sender
        else sender

